apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-init-script
  namespace: mlops-hub
data:
  init-minio.sh: |
    #!/bin/bash
    set -e
    
    echo "Starting MinIO server..."
    minio server /data --console-address ":9001" &
    MINIO_PID=$!
    
    echo "Waiting for MinIO to be ready..."
    until mc alias set myminio http://localhost:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD; do
      echo "Waiting for MinIO to be ready..."
      sleep 2
    done
    
    echo "Creating mlops-hub bucket..."
    mc mb myminio/mlops-hub --ignore-existing
    
    echo "Creating mlflow bucket..."
    mc mb myminio/mlflow --ignore-existing
    
    echo "Setting bucket policies..."
    mc anonymous set public myminio/mlops-hub
    mc anonymous set public myminio/mlflow
    
    echo "MinIO setup complete!"
    
    # Keep the server running
    wait $MINIO_PID
