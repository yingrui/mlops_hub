apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: mlops-hub
  labels:
    app: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:23.0
        ports:
        - containerPort: 8080
        env:
        - name: KEYCLOAK_ADMIN
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KEYCLOAK_ADMIN
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mlops-secrets
              key: KEYCLOAK_ADMIN_PASSWORD
        - name: KC_DB
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KC_DB
        - name: KC_DB_URL
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KC_DB_URL
        - name: KC_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KC_DB_USERNAME
        - name: KC_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mlops-secrets
              key: KEYCLOAK_DB_PASSWORD
        - name: KC_HOSTNAME_STRICT
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KC_HOSTNAME_STRICT
        - name: KC_HOSTNAME_STRICT_HTTPS
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KC_HOSTNAME_STRICT_HTTPS
        - name: KC_HTTP_ENABLED
          valueFrom:
            configMapKeyRef:
              name: mlops-config
              key: KC_HTTP_ENABLED
        - name: KC_IMPORT
          value: /opt/keycloak/data/import/keycloak-realm.json
        command:
        - /bin/bash
        - -c
        - |
          /opt/keycloak/bin/kc.sh start-dev --import-realm
        volumeMounts:
        - name: keycloak-realm
          mountPath: /opt/keycloak/data/import/keycloak-realm.json
          subPath: keycloak-realm.json
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
      volumes:
      - name: keycloak-realm
        configMap:
          name: keycloak-realm-config
      initContainers:
      - name: wait-for-postgres
        image: postgres:15
        command:
        - /bin/bash
        - -c
        - |
          until pg_isready -h postgres-service -p 5432 -U keycloak_user; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: mlops-secrets
              key: POSTGRES_MULTIPLE_PASSWORDS
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak-service
  namespace: mlops-hub
  labels:
    app: keycloak
spec:
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
  selector:
    app: keycloak
